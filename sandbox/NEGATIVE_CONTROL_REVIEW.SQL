SELECT *
INTO EVIDENCE.NC_OUTCOME_VOCAB_REVIEW
FROM (
	SELECT 'DESCENDANT' AS MAPPING_TYPE,
		u.CONCEPT_ID AS OUTCOME_OF_INTEREST_CONCEPT_ID, 
		u.CONCEPT_NAME AS OUTCOME_OF_INTEREST_CONCEPT_NAME, 
		a.SOURCE_CODE_2, 
		a.SOURCE_CODE_NAME_2,
		a.UNIQUE_IDENTIFIER, 
		a.UNIQUE_IDENTIFIER_TYPE, 
		a.PUBLICATION_TYPE
	FROM EVIDENCE.NC_CONCEPT_UNIVERSE u
		JOIN VOCABULARY.CONCEPT_ANCESTOR ca
			ON ca.DESCENDANT_CONCEPT_ID = u.CONCEPT_ID
		JOIN TRANSLATED.MEDLINE_AVILLACH a
			ON a.CONCEPT_ID_2 = ca.ANCESTOR_CONCEPT_ID
			AND a.CONCEPT_ID_2 != ca.DESCENDANT_CONCEPT_ID
	WHERE CONCEPT_ID_1 IN (
		SELECT CONCEPT_ID
		FROM VOCABULARY.CONCEPT
		WHERE CONCEPT_ID IN (932745,956874,942350)
		UNION ALL
		SELECT DESCENDANT_CONCEPT_ID
		FROM VOCABULARY.CONCEPT_ANCESTOR
		WHERE ANCESTOR_CONCEPT_ID IN (932745,956874,942350)
	)
	
	UNION ALL
	SELECT 'EXACT' AS MAPPING_TYPE,
		u.CONCEPT_ID AS OUTCOME_OF_INTEREST_CONCEPT_ID, 
		u.CONCEPT_NAME AS OUTCOME_OF_INTEREST_CONCEPT_NAME, 
		a.SOURCE_CODE_2, 
		a.SOURCE_CODE_NAME_2,
		a.UNIQUE_IDENTIFIER, 
		a.UNIQUE_IDENTIFIER_TYPE, 
		a.PUBLICATION_TYPE
	FROM EVIDENCE.NC_CONCEPT_UNIVERSE u
		JOIN TRANSLATED.MEDLINE_AVILLACH a
			ON a.CONCEPT_ID_2 = u.CONCEPT_ID
	WHERE CONCEPT_ID_1 IN (
		SELECT CONCEPT_ID
		FROM VOCABULARY.CONCEPT
		WHERE CONCEPT_ID IN (932745,956874,942350)
		UNION ALL
		SELECT DESCENDANT_CONCEPT_ID
		FROM VOCABULARY.CONCEPT_ANCESTOR
		WHERE ANCESTOR_CONCEPT_ID IN (932745,956874,942350)
	)
	
	UNION ALL
	SELECT 'PARENT' AS MAPPING_TYPE,
		u.CONCEPT_ID AS OUTCOME_OF_INTEREST_CONCEPT_ID, 
		u.CONCEPT_NAME AS OUTCOME_OF_INTEREST_CONCEPT_NAME,
		a.SOURCE_CODE_2, 
		a.SOURCE_CODE_NAME_2,
		a.UNIQUE_IDENTIFIER, 
		a.UNIQUE_IDENTIFIER_TYPE, 
		a.PUBLICATION_TYPE
	FROM EVIDENCE.NC_CONCEPT_UNIVERSE u
		JOIN VOCABULARY.CONCEPT_RELATIONSHIP cr
			ON cr.CONCEPT_ID_2 = u.CONCEPT_ID
			AND UPPER(cr.RELATIONSHIP_ID) = 'IS A'
		JOIN TRANSLATED.MEDLINE_AVILLACH a
			ON a.CONCEPT_ID_2 = cr.CONCEPT_ID_1
			AND a.CONCEPT_ID_2 != cr.CONCEPT_ID_2
	WHERE a.CONCEPT_ID_1 IN (
		SELECT CONCEPT_ID
		FROM VOCABULARY.CONCEPT
		WHERE CONCEPT_ID IN (932745,956874,942350)
		UNION ALL
		SELECT DESCENDANT_CONCEPT_ID
		FROM VOCABULARY.CONCEPT_ANCESTOR
		WHERE ANCESTOR_CONCEPT_ID IN (932745,956874,942350)
	)
	
	UNION ALL
	SELECT 'ANCESTOR' AS MAPPING_TYPE,
		u.CONCEPT_ID AS OUTCOME_OF_INTEREST_CONCEPT_ID, 
		u.CONCEPT_NAME AS OUTCOME_OF_INTEREST_CONCEPT_NAME, 
		a.SOURCE_CODE_2, 
		a.SOURCE_CODE_NAME_2,
		a.UNIQUE_IDENTIFIER, 
		a.UNIQUE_IDENTIFIER_TYPE, 
		a.PUBLICATION_TYPE
	FROM EVIDENCE.NC_CONCEPT_UNIVERSE u
		JOIN VOCABULARY.CONCEPT_ANCESTOR ca
			ON ca.ANCESTOR_CONCEPT_ID = u.CONCEPT_ID
		JOIN TRANSLATED.MEDLINE_AVILLACH a
			ON a.CONCEPT_ID_2 = ca.DESCENDANT_CONCEPT_ID
			AND a.CONCEPT_ID_2 != ca.ANCESTOR_CONCEPT_ID
	WHERE CONCEPT_ID_1 IN (
		SELECT CONCEPT_ID
		FROM VOCABULARY.CONCEPT
		WHERE CONCEPT_ID IN (932745,956874,942350)
		UNION ALL
		SELECT DESCENDANT_CONCEPT_ID
		FROM VOCABULARY.CONCEPT_ANCESTOR
		WHERE ANCESTOR_CONCEPT_ID IN (932745,956874,942350)
	)
	
) z;

SELECT u.CONCEPT_ID AS OUTCOME_OF_INTEREST_CONCEPT_ID,
	u.CONCEPT_NAME AS OUTCOME_OF_INTEREST_CONCEPT_NAME,
	u.PERSON_COUNT_RC, u.PERSON_COUNT_DC,
	COUNT(DISTINCT descendant.UNIQUE_IDENTIFIER) AS DESCENDANT_PMID_COUNT,
	COUNT(DISTINCT exact.UNIQUE_IDENTIFIER) AS EXACT_PMID_COUNT,
	COUNT(DISTINCT parent.UNIQUE_IDENTIFIER) AS PARENT_PMID_COUNT,
	COUNT(DISTINCT ancestor.UNIQUE_IDENTIFIER) AS ANCESTOR_PMID_COUNT,
	MAX(CASE WHEN i.CONCEPT_ID IS NULL THEN 0 ELSE 1 END) AS INDICATION,
	MAX(CASE WHEN tb.CONCEPT_ID IS NULL THEN 0 ELSE 1 END) AS TOO_BROAD,
	MAX(CASE WHEN di.CONCEPT_ID IS NULL THEN 0 ELSE 1 END) AS DRUG_INDUCED,
	MAX(CASE WHEN p.CONCEPT_ID IS NULL THEN 0 ELSE 1 END) AS PREGNANCY,
	MAX(CASE WHEN s.CONCEPT_ID IS NULL THEN 0 ELSE 1 END) AS SPLICER, 
	MAX(CASE WHEN f.CONCEPT_ID IS NULL THEN 0 ELSE 1 END) AS FAERS,
	MAX(CASE WHEN ue.CONCEPT_ID IS NULL THEN 0 ELSE 1 END) AS USER_EXCLUDED,
	MAX(CASE WHEN ui.CONCEPT_ID IS NULL THEN 0 ELSE 1 END) AS USER_INCLUDED
FROM EVIDENCE.NC_CONCEPT_UNIVERSE u
	LEFT OUTER JOIN EVIDENCE.NC_OUTCOME_VOCAB_REVIEW descendant
		ON descendant.OUTCOME_OF_INTEREST_CONCEPT_ID = u.CONCEPT_ID 
		AND descendant.MAPPING_TYPE = 'DESCENDANT'
	LEFT OUTER JOIN EVIDENCE.NC_OUTCOME_VOCAB_REVIEW exact
		ON exact.OUTCOME_OF_INTEREST_CONCEPT_ID = u.CONCEPT_ID 
		AND exact.MAPPING_TYPE = 'EXACT'
	LEFT OUTER JOIN EVIDENCE.NC_OUTCOME_VOCAB_REVIEW parent
		ON parent.OUTCOME_OF_INTEREST_CONCEPT_ID = u.CONCEPT_ID 
		AND parent.MAPPING_TYPE = 'PARENT'
	LEFT OUTER JOIN EVIDENCE.NC_OUTCOME_VOCAB_REVIEW ancestor
		ON ancestor.OUTCOME_OF_INTEREST_CONCEPT_ID = u.CONCEPT_ID 
		AND ancestor.MAPPING_TYPE = 'ANCESTOR'
	LEFT OUTER JOIN EVIDENCE.NC_INDICATIONS i
		ON i.CONCEPT_ID = u.CONCEPT_ID
	LEFT OUTER JOIN EVIDENCE.NC_BROAD_CONDITIONS tb
		ON tb.CONCEPT_ID = u.CONCEPT_ID
	LEFT OUTER JOIN EVIDENCE.NC_DRUG_INDUCED_CONDITIONS di
		ON di.CONCEPT_ID = u.CONCEPT_ID
	LEFT OUTER JOIN EVIDENCE.NC_PREGNANCY_CONDITIONS p
		ON p.CONCEPT_ID = u.CONCEPT_ID
	LEFT OUTER JOIN EVIDENCE.NC_SPLICER_CONDITIONS s
		ON s.CONCEPT_ID = u.CONCEPT_ID
	LEFT OUTER JOIN EVIDENCE.NC_FAERS_CONCEPTS f
		ON f.CONCEPT_ID = u.CONCEPT_ID
	LEFT OUTER JOIN EVIDENCE.NC_EXCLUDED_CONCEPTS ue
		ON ue.CONCEPT_ID = u.CONCEPT_ID
	LEFT OUTER JOIN EVIDENCE.NC_INCLUDED_CONCEPTS ui
		ON ui.CONCEPT_ID = u.CONCEPT_ID	
GROUP BY u.CONCEPT_ID, u.CONCEPT_NAME, u.PERSON_COUNT_RC, u.PERSON_COUNT_DC
ORDER BY PERSON_COUNT_DC DESC, PERSON_COUNT_RC





